// Xenly Multiprocessing Test Suite
print("╔════════════════════════════════════════════════════════╗")
print("║   Xenly High-Performance Multiprocessing Test Suite   ║")
print("╚════════════════════════════════════════════════════════╝")
print()

print("System Information:")
print("  CPU Cores:", cpu_count())
print()

// Test 1: Basic Thread Pool
print("Test 1: Basic Thread Pool")
print("─────────────────────────────")

fn square(n) {
    return n * n
}

var pool = thread_pool_create(2)
var fut = thread_pool_submit(pool, square, 7)
var result = future_get(fut)

if (result == 49) {
    print("✓ Task executed correctly (7² = 49)")
}

future_destroy(fut)
thread_pool_destroy(pool)
print()

// Test 2: Parallel Fibonacci
print("Test 2: Parallel Fibonacci Computation")
print("───────────────────────────────────────")

fn fib(n) {
    if (n <= 1) { return n }
    return fib(n-1) + fib(n-2)
}

pool = thread_pool_create(4)

var f1 = thread_pool_submit(pool, fib, 20)
var f2 = thread_pool_submit(pool, fib, 21)
var f3 = thread_pool_submit(pool, fib, 22)
var f4 = thread_pool_submit(pool, fib, 23)
var f5 = thread_pool_submit(pool, fib, 24)
var f6 = thread_pool_submit(pool, fib, 25)

print("Computing fib(20-25) in parallel...")

var r1 = future_get(f1)
var r2 = future_get(f2)
var r3 = future_get(f3)
var r4 = future_get(f4)
var r5 = future_get(f5)
var r6 = future_get(f6)

print("✓ All results:")
print("  fib(20) =", r1)
print("  fib(21) =", r2)
print("  fib(22) =", r3)
print("  fib(23) =", r4)
print("  fib(24) =", r5)
print("  fib(25) =", r6)

future_destroy(f1)
future_destroy(f2)
future_destroy(f3)
future_destroy(f4)
future_destroy(f5)
future_destroy(f6)
thread_pool_destroy(pool)
print()

// Test 3: Channels
print("Test 3: Buffered Channels")
print("─────────────────────────")

var chan = channel_create(5)
print("Created buffered channel (capacity = 5)")

channel_send(chan, 100)
channel_send(chan, 200)
channel_send(chan, 300)
print("Sent 3 values: 100, 200, 300")

var v1 = channel_recv(chan)
var v2 = channel_recv(chan)
var v3 = channel_recv(chan)

print("✓ Channel FIFO order preserved")
print("  Received:", v1, v2, v3)

channel_destroy(chan)
print()

// Test 4: Future Status
print("Test 4: Future Status Checking")
print("───────────────────────────────")

fn slow_task(n) {
    var sum = 0
    var i = 0
    while (i < 1000000) {
        sum = sum + i
        i = i + 1
    }
    return n * 2
}

pool = thread_pool_create(1)
fut = thread_pool_submit(pool, slow_task, 21)

var ready = future_is_ready(fut)
print("Future ready immediately:", ready)

result = future_get(fut)
ready = future_is_ready(fut)

print("✓ Future status tracking works")
print("  Final ready status:", ready)
print("  Result:", result)

future_destroy(fut)
thread_pool_destroy(pool)
print()

// Test 5: Multiple Pools
print("Test 5: Multiple Thread Pools")
print("──────────────────────────────")

var pool1 = thread_pool_create(2)
var pool2 = thread_pool_create(2)

var fut1 = thread_pool_submit(pool1, square, 5)
var fut2 = thread_pool_submit(pool2, square, 10)

var res1 = future_get(fut1)
var res2 = future_get(fut2)

print("✓ Multiple pools work independently")
print("  Pool 1 result:", res1)
print("  Pool 2 result:", res2)

future_destroy(fut1)
future_destroy(fut2)
thread_pool_destroy(pool1)
thread_pool_destroy(pool2)
print()

print("╔════════════════════════════════════════════════════════╗")
print("║              All Tests Passed! ✓                       ║")
print("╚════════════════════════════════════════════════════════╝")
print()
print("Multiprocessing system verified:")
print("  • Thread pools execute tasks in parallel")
print("  • Futures properly track async results")
print("  • Channels handle FIFO message passing")
print("  • Multiple pools can coexist")
